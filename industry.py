import json
import pandas as pd
from datetime import datetime, timedelta
from stock_module.mongo import *

industry = {
    "油電燃氣": ["1434", "1714", "6505", "8926"],
    "玻璃": ["1802", "1806", "1809", "1810"],
    "水泥": ["1101", "1102", "1103", "1104", "1108", "1109", "8936"],
    "大宗物資": ["1210", "1215", "1218", "1219", "1225", "1229", "1702"],
    "綜合食品": ["1201", "1215", "1216", "1217", "1218", "1227", "4123"],
    "塑膠原料": ["1301", "1303", "1304", "1305", "1308", "1309", "1310", "1312", "1313", "1326", "6505"],
    "塑膠製品": ["1303", "1307", "1321", "1225", "3171", "4306"],
    "加工絲": ["1402", "1444", "1452", "1455", "1457", "1459"],
    "棉紡": ["1414", "1440", "1441"],
    "尼龍": ["1314", "1434", "1447", "1455"],
    "成衣": ["1476", "1477", "4414", "8916"],
    "長織布": ["1434", "1460", "1474", "1476"],
    "不織布": ["1325", "6504", "9919"],
    "聚酯纖維": ["1402", "1409", "1440", "1444", "1303", "1710", "1718"],
    "重電業": ["1504", "1513", "1514", "1519", "1537"],
    "家電": ["1504", "2371", "2430", "3024", "4930", "1604", "6275"],
    "機械零組件": ["2049", "2233", "1590", "1589", "1597", "4576", "4551", "4540"],
    "飛機零組件": ["5009", "2634", "8383", "1584"],
    "電線電纜": ["1605", "1609", "1608", "1603", "1612", "1615", "1618", "1617"],
    "化工": ["1722", "1710", "1717", "1714", "1708", "1732", "4716", "1711", "1712", "3708"],
    "電池材料": ["4721", "4739", "6509", "5227", "8215"],
    "電池相關": ["6121", "3211", "8171", "3323", "3625", "6558"],
    "原料藥": ["1762", "4746", "4119", "4167", "1789", "3705"],
    "西藥製劑": ["4105", "4743", "6472", "4157", "6492", "4123", "1795", "4162", "3176", "1760", "6446"],
    "醫療產品": ["9103", "4106", "4736", "3373", "6491", "1565", "4121", "4735", "1781", "1733", "8406"],
    "保健品": ["4743", "1734", "8436", "4128", "3164", "1720", "1707"],
    "藥品通路": ["1731", "6469", "8403"],
    "建材": ["1802", "1806", "2597", "1603", "8942", "1809", "1507"],
    "造紙": ["1904", "1905", "1907", "1909"],
    "不鏽鋼": ["2027", "1605", "2034", "2030", "2007", "5014", "5009", "2069", "2032", "2221"],
    "平板鋼": ["2002", "2014", "2023", "2031", "2006", "2020", "2029", "2010", "2028"],
    "線材/盤元": ["2022", "2007", "2017", "8415", "2033", "2012", "2023", "2024", "2027"],
    "條鋼": ["2002", "2014", "2006", "9958", "2038", "2020", "2010", "2028", "2013", "2015"],
    "橡膠原料": ["2103", "2104", "2108", "6582"],
    "橡膠輪胎": ["2101", "2102", "2105", "2106", "2107"],
    "車用電子": [
        "2308",
        "8016",
        "3552",
        "2436",
        "2458",
        "4919",
        "3227",
        "5471",
        "2481",
        "6138",
        "2231",
        "6202",
        "3706",
        "2355",
        "8054",
        "5425",
        "6129",
        "6283",
        "3122",
        "3094",
        "8255",
        "3556",
        "5309",
        "5302",
        "1533",
        "2497",
    ],
    "汽車股": ["2201", "2204", "2206", "2207", "2227", "6592", "9941", "5871"],
    "汽車零組件": ["6781", "2231", "1536", "2233", "8255", "1338", "1532", "1533", "4551", "1319", "2239", "1587"],
    "車燈": ["1521", "1522", "2393", "3346", "6288", "6605"],
    "車用傳動系統組件": ["1536", "2233", "4528", "4551", "4566"],
    "驅動馬達散熱系統": ["2421", "4551", "6275"],
    "充電樁": ["1519", "1586", "2201", "2308", "2382", "2457", "3003", "3023", "3058", "4938", "6282"],
    "車用被動元件": ["2327", "2428", "2456", "2472", "2492", "3042", "3221", "6224", "6642"],
    "車用半導體": ["2379", "2436", "2454", "2481", "5425", "8255", "6525"],
    "車用感測元件": ["2449", "3374", "4919", "6271"],
    "LiDAR/雷達感測": ["2413", "3105", "2231", "3552"],
    "IC封測": [
        "3711",
        "3374",
        "6239",
        "2449",
        "2351",
        "6271",
        "6261",
        "6451",
        "8150",
        "6223",
        "6147",
        "6257",
        "2441",
        "8110",
        "3264",
        "6510",
        "2369",
        "2329",
        "3305",
    ],
    "邏輯IC封測": ["3711", "2441", "2449", "3265"],
    "LCD驅動IC封測": ["8150", "6147"],
    "記憶體封測": ["6239", "8150", "2329", "8131"],
    "RF/PMIC封測": ["6257", "3264", "6147", "2449", "3711", "2441", "2369"],
    "CIS封測": ["2369", "3374", "2449", "6271"],
    "導線架": ["2351", "5285", "6548", "8070"],
    "探針卡": ["6223", "6510", "6515", "6683"],
    "IC載板": ["3037", "8046", "3189", "6552"],
    "快充IC": ["6415", "3588", "8081", "4961", "6104", "2436", "6411", "5351"],
    "LCD驅動IC": ["4966", "3034", "8016", "4961", "3545", "3141", "6129"],
    "LED驅動IC": ["2436", "3527", "3588", "6415", "8081"],
    "FLASH記憶體IC": ["3006", "8054", "3529", "6485", "8299"],
    "DRAM記憶體IC": ["3006", "5351", "6531"],
    "無線網路IC": ["2454", "2379", "5272", "6129", "8040"],
    "馬達IC": ["2436", "3141", "6138", "6233"],
    "IO控制IC": ["3014", "3169", "4919"],
    "類比IC": ["6415", "2436", "8081", "6138", "8261", "3588", "3438", "3257"],
    "消費性IC": ["2401", "2436", "3014", "3041", "3556", "4919", "4952", "5302", "5471", "6129", "6202"],
    "LCD控制IC": ["2379", "2454", "3034", "4952", "4966"],
    "IP設計": ["2401", "3035", "3443", "3529", "3661", "6531", "6533", "6643"],
    "生物辨識IC": ["2458", "3545", "6202", "6462"],
    "觸控IC": ["4966", "3034", "8016", "3545", "2458", "3141", "3014", "5471", "3556", "2363", "6243"],
    "高速傳輸介面IC": ["5269", "4966", "6104", "6233", "6594", "6684", "6756", "8054", "5351", "3035", "2379"],
    "USB IC": ["8299", "5269", "6104", "8054", "6233"],
    "集線器IC": ["2379", "6104", "8054", "6594"],
    "MCU": ["2436", "4952", "6202", "3438", "4919", "5471", "5302", "6457", "8024", "3122", "6494", "6229"],
    "IC零組件通路商": ["8112", "3036", "3048", "3033", "3209", "3312", "3702"],
    "LED": ["6271", "6261", "6278", "3714", "2393", "2340", "2486", "2426", "2491", "3437", "8111"],
    "TFT面板": ["3481", "2409", "6116", "8069", "6176", "4935", "4960", "5371", "3149", "8215"],
    "TN/STN面板": ["3038", "5315", "8105"],
    "電子紙": ["8069", "6143", "3141"],
    "工業電腦": ["2395", "6414", "8076", "8050", "3594", "3022", "6166", "3416"],
    "二極體": ["2481", "5425", "8255", "2302", "3675"],
    "MOSFET": ["3707", "6138", "8261", "5299", "3317", "3016", "6435", "2342"],
    "非揮發性記憶體": ["2337", "2344"],
    "晶圓代工": ["2303", "2330", "2337", "2342", "3707", "4919", "5347", "6770"],
    "矽晶圓": ["6488", "5483", "6182", "3532", "3016"],
    "太陽能": ["5483", "6443", "3576", "6477", "6244", "3691", "2406", "6538", "4934", "3686", "3713"],
    "風力發電": [
        "3708",
        "9958",
        "1589",
        "1503",
        "1504",
        "1519",
        "2371",
        "2308",
        "3010",
        "3211",
        "3323",
        "6121",
        "6170",
        "6441",
        "1605",
        "1609",
        "3023",
        "8926",
    ],
    "手機股": ["2317", "2498", "4938"],
    "無線充電": [
        "2454",
        "3260",
        "2308",
        "6415",
        "4919",
        "5471",
        "6138",
        "2301",
        "6202",
        "3078",
        "4915",
        "3015",
        "3540",
        "4952",
        "6155",
    ],
    "手機零組件": [
        "3481",
        "2409",
        "3545",
        "2454",
        "3034",
        "3037",
        "8016",
        "3406",
        "6116",
        "3008",
        "2313",
        "2367",
        "2439",
        "8105",
        "3622",
        "2402",
        "3508",
        "3673",
    ],
    "半導體": [
        "2330",
        "2303",
        "6488",
        "2344",
        "3661",
        "2337",
        "5483",
        "2408",
        "4919",
        "6182",
        "5347",
        "2338",
        "3707",
        "3532",
        "3016",
        "2342",
        "8028",
    ],
    "砷化鎵相關": ["3105", "8086", "2455", "3081"],
    "石英元件": ["3042", "2484", "8182", "3221", "6174", "8289"],
    "光學鏡頭": ["3008", "3406", "4976", "3019", "3362", "3630", "6209"],
    "PCB": [
        "8046",
        "3037",
        "2368",
        "4958",
        "2313",
        "3044",
        "6278",
        "6191",
        "4927",
        "2367",
        "2355",
        "6251",
        "8213",
        "5469",
        "8183",
        "5439",
        "2316",
    ],
    "PCB上游與材料": ["1802", "8358", "1303", "2383", "8021", "6213", "1815", "6274", "1612", "6672", "3305", "4989"],
    "銅箔基板": ["2383", "6213", "6274", "6672", "1612"],
    "軟板": ["4958", "6269", "6153", "8039", "2402", "3645", "4939"],
    "手機HDI板": ["2313", "3037", "8046", "2367", "2316", "3044"],
    "車用板": ["2355", "4927", "6251", "5439", "6191", "3044", "8183"],
    "網通/基地台/伺服器板": ["2368", "5439", "8155", "5469", "3044"],
    "PC/NB板": ["3044", "5469", "2368", "6191"],
    "光電板": ["3044", "6251", "8213"],
    "安全監控系統": ["2390", "3356", "3128", "6560", "3454"],
    "背光板": ["6176", "4935", "5371", "6120"],
    "音響設備及零件": ["2415", "2477", "2488", "3465"],
    "利基型記憶體": ["3006", "2344", "2408", "5351"],
    "記憶體模組": ["3260", "4967", "2451", "8271", "8088", "4973", "8277"],
    "軟體": ["3687", "6462", "6214", "3029", "6180", "6221", "6163", "4953", "3147", "5203", "2480", "2453", "6231"],
    "遊戲相關": ["3293", "2354", "6441", "5263", "5478", "6180", "3083", "3546", "6111"],
    "電商": ["2614", "8454", "6741", "8044", "3045", "2734", "5287", "8477"],
    "無線網路": ["3596", "4906", "2332", "6285", "3380", "3062", "3694", "6142", "5388", "3047"],
    "電腦板卡": ["2357", "2376", "2377", "6150", "3515", "2399", "2465", "2331", "2425", "5386"],
    "筆記型電腦": ["2357", "2382", "2377", "2353", "2324", "4938", "3231", "2356", "2331", "3005", "2405", "2362"],
    "鍵盤": ["2385", "2387", "4915", "5215", "8163"],
    "周邊產品": [
        "8299",
        "2328",
        "2385",
        "2301",
        "4915",
        "8163",
        "6188",
        "6283",
        "3060",
        "5215",
        "2365",
        "2387",
        "1711",
        "5289",
        "2380",
        "5309",
        "1586",
        "3057",
        "3322",
    ],
    "伺服器": [
        "2059",
        "2317",
        "2324",
        "2356",
        "2382",
        "3706",
        "6669",
        "4919",
        "5274",
        "2368",
        "3044",
        "8155",
        "3617",
        "6409",
        "3032",
        "5465",
    ],
    "電源相關": ["2308", "2457", "6203", "2301", "6409", "3078", "6282", "3484", "3058", "3015", "3540", "6412"],
    "機殼": ["2474", "2354", "3540", "8210", "3325", "3508", "5392", "1471", "3032", "6235"],
    "顯示器": ["2489", "2352", "4153", "5283"],
    "觸控面板": ["6456", "3049", "3615", "3622", "3673"],
    "投影機相關": ["3669", "5371", "3504"],
    "視訊相關": ["2417", "2485", "5474", "6152", "3669"],
    "散熱風扇": ["2421", "3071", "5223", "6591"],
    "散熱模組": ["3653", "3017", "3324", "3483", "2421", "6591", "6230", "3338", "6275"],
    "模具沖壓": ["5243", "4912", "2476", "3178", "5223", "1586", "3679", "1569", "4942"],
    "鋁鎂合金外殼": ["2354", "2474", "6235"],
    "樞紐": ["3376", "1582", "3548", "4999"],
    "連接線材": ["2328", "3665", "3023", "6290", "3092", "2392", "6190", "8103", "3605", "6715", "2440", "3322", "3550"],
    "連接器": [
        "2317",
        "3533",
        "3023",
        "2460",
        "3338",
        "3003",
        "5457",
        "2392",
        "3217",
        "6279",
        "8103",
        "3605",
        "3511",
        "4943",
        "3526",
    ],
    "被動元件": [
        "2327",
        "2492",
        "2375",
        "3042",
        "3026",
        "2456",
        "6173",
        "4760",
        "6224",
        "3090",
        "2472",
        "2478",
        "2428",
        "8182",
        "6127",
        "2484",
        "3624",
        "6449",
        "6175",
    ],
    "MLCC": ["2327", "2492", "3026", "6173", "8043"],
    "電子代工": [
        "2317",
        "3711",
        "2345",
        "2382",
        "2324",
        "4938",
        "2498",
        "2371",
        "2352",
        "3231",
        "3596",
        "2354",
        "2312",
        "6278",
        "6191",
        "2314",
        "3704",
        "3059",
        "2331",
        "8183",
    ],
    "電信股": ["2412", "3045", "4904"],
    "網路通訊": [
        "2345",
        "3596",
        "2419",
        "3152",
        "6416",
        "2314",
        "3704",
        "6284",
        "4906",
        "2332",
        "6285",
        "5388",
        "3380",
        "6245",
        "3027",
        "3025",
        "3062",
        "3694",
        "6142",
    ],
    "光收發模組": ["4908", "4977", "4979"],
    "光纖產品": ["3163", "6426", "8011"],
    "光纖次模組封裝": ["3450", "4977", "3234", "4908", "4979"],
    "光纖被動元件": ["3163", "3363", "8011"],
    "無塵室工程": ["2404", "5536", "8383", "3402", "6139"],
    "設備儀器廠商": [
        "3413",
        "6187",
        "6223",
        "2360",
        "3680",
        "5443",
        "3131",
        "6196",
        "2464",
        "3563",
        "2467",
        "3030",
        "3580",
        "6125",
        "6208",
        "6215",
        "8027",
        "8499",
        "6438",
    ],
    "半導體設備": [
        "2467",
        "6187",
        "6438",
        "7556",
        "2360",
        "3551",
        "3413",
        "3680",
        "3131",
        "6196",
        "3583",
        "6532",
        "3178",
        "6208",
    ],
    "封裝設備": ["3131", "3581", "3583", "6187", "6640"],
    "PCB設備": ["1595", "2467", "2493", "3167", "3563", "6438", "6664", "6727", "8027"],
    "檢測驗證服務": ["3138", "3587", "3289", "6146", "3055"],
    "其他電子通路": ["5434", "8070", "3010", "5452", "6170", "3388"],
    "機器人": ["2317", "2357", "2324", "4938", "2395", "6188", "5443", "2464", "6125", "6166", "3498"],
    "穿戴式裝置": ["2317", "2357", "2382", "2353", "2324", "4938", "2385", "2312", "2356", "3706", "2402", "2413"],
    "營建": [
        "9945",
        "2542",
        "2520",
        "6219",
        "3056",
        "5519",
        "2548",
        "2505",
        "2597",
        "2545",
        "2501",
        "2107",
        "5512",
        "5522",
        "5531",
        "5534",
        "5213",
        "2547",
        "2534",
    ],
    "營造": ["2515", "2520", "2535", "3703", "5519", "2597", "2511", "5521", "5512", "9933", "3052", "2546"],
    "資產股": ["1314", "1440", "1409", "1402", "2371", "2201", "1722", "2913", "2102", "2206", "2101", "1504"],
    "製罐": ["9939", "9907", "9905"],
    "航空": ["2610", "2618", "5609"],
    "貨櫃航運": ["2603", "2609", "2615"],
    "散裝航運": ["2637", "2606", "2605", "2617", "2641", "2612", "2601", "5608"],
    "物流業": ["2636", "2642", "2607", "2612", "2608", "5609", "2611", "2613", "5603", "5607"],
    "觀光百貨": ["2915", "2912", "2601", "2913", "2611", "2707", "2731", "3557", "2903", "2906"],
    "餐飲": ["2727", "2723", "2732", "2729", "2752"],
    "飯店": ["2511", "2707", "5905", "2514", "2705", "2704", "2702"],
    "金控": ["2880", "2881", "2882", "2883", "2884", "2885", "2886", "2887", "2888", "2889", "2890", "2891", "2892"],
    "保險": ["2823", "2867", "2851", "2850"],
    "證券": ["6015", "6005", "2855", "6016", "6026", "5864", "6024"],
    "銀行": ["5876", "2801", "2834", "2812", "2809", "2845", "2838", "2897"],
    "其他金融": ["5871", "2889", "2820"],
    "自行車": ["9914", "9921", "5306", "1517", "1526", "8933"],
    "高爾夫球": ["8924", "8938", "6670"],
    "健身器材": ["1515", "1593", "1598", "1736"],
    "運動鞋": ["9802", "9904", "9910", "1307", "4426", "4766", "8404", "9938"],
    "元宇宙": ["2498", "3508", "2388", "5351", "2340", "3169", "6237", "3504"],
    "第三代半導體": ["3707", "4971", "3016", "2455", "6525", "3105", "8086", "3374", "2342", "3714", "5483", "4934"],
}

holiday = pd.to_datetime(
    [
        "2021-01-01",
        "2021-01-04",
        "2021-02-05",
        "2021-02-08",
        "2021-02-09",
        "2021-02-10",
        "2021-02-11",
        "2021-02-12",
        "2021-02-13",
        "2021-02-14",
        "2021-02-15",
        "2021-02-16",
        "2021-02-17",
        "2021-02-28",
        "2021-03-01",
        "2021-04-02",
        "2021-04-03",
        "2021-04-04",
        "2021-04-05",
        "2021-04-30",
        "2021-05-01",
        "2021-06-14",
        "2021-09-20",
        "2021-09-21",
        "2021-10-10",
        "2021-10-11",
        "2021-12-31",
        "2022-01-01",
        "2022-01-03",
        "2022-01-26",
        "2022-01-27",
        "2022-01-28",
        "2022-01-31",
        "2022-02-01",
        "2022-02-02",
        "2022-02-03",
        "2022-02-04",
        "2022-02-07",
        "2022-02-28",
        "2022-04-04",
        "2022-04-05",
        "2022-05-01",
        "2022-05-02",
        "2022-06-03",
        "2022-09-09",
        "2022-09-10",
        "2022-10-10",
    ]
)


def get_price_data(stocks):
    data = []
    days = 365
    t_index = pd.date_range(
        pd.to_datetime(datetime.today() - timedelta(days=days)).date(), datetime.today(), freq="B", name="date"
    )
    for i in holiday:
        if i in t_index:
            t_index = t_index.drop(i)
            
    for stock in stocks:
        df = get_data_by_stock_id("price", stock, ["開盤價", "最高價", "最低價", "收盤價", "成交金額"], days)

        df = df.reindex(t_index)
        df = df.fillna(method="ffill")
        df = df.fillna(method="bfill")
        df["price%"] = df["收盤價"] / df["收盤價"].shift(1)
        df["open%"] = df["開盤價"] / df["收盤價"].shift(1)
        df["high%"] = df["最高價"] / df["收盤價"].shift(1)
        df["low%"] = df["最低價"] / df["收盤價"].shift(1)
        df["volume"] = df["成交金額"] / 10000

        data.append(df)
    return data


def dataframe(industry, data):
    df_new = pd.DataFrame(sum(data))[["price%", "open%", "high%", "low%"]] / len(data)
    df_new["close"] = 100 * df_new["price%"].cumprod()
    df_new["close"].iloc[0] = 100
    df_new["open"] = df_new["open%"] * df_new["close"].shift(1)
    df_new["high"] = df_new["high%"] * df_new["close"].shift(1)
    df_new["low"] = df_new["low%"] * df_new["close"].shift(1)
    df_new["volume"] = sum(data)["volume"]
    df_new["volume%"] = df_new["volume"] / df_new["volume"].shift(1)
    df_new = df_new.drop(["open%", "high%", "low%"], axis=1)
    df_new.iloc[0].loc[["open", "high", "low"]] = 100
    df_new = df_new.round({"price%": 3, "close": 1, "open": 1, "high": 1, "low": 1, "volume": 1, "volume%": 2})
    df_new = df_new.fillna(method="ffill")
    df_new["industry"] = industry
    df_new = df_new.reindex(columns=["industry", "price%", "volume", "volume%", "close", "open", "high", "low"])

    return df_new


def create_index():
    df = pd.DataFrame()
    for key, value in industry.items():
        data = get_price_data(value)
        df2 = dataframe(key, data)
        df = pd.concat([df, df2.tail(1)])

    df.columns = ["industry", "price%", "volume", "volume%", "close", "open", "high", "low"]

    json_data = json.loads(df.to_json(orient="records"))
    db["industry"].remove()
    save_to_mongo(json_data, "industry")

    return
